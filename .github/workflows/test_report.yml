name: test_report
on:
  workflow_call:
    inputs:
      test_jobs:
        description: "Comma-separated list of test job names to wait for"
        type: string
        required: true
jobs:
  flavor_version_data:
    name: Download flavor version data from trigger
    uses: ./.github/workflows/download_flavor_version_data.yml
    with:
      run_id: ${{ github.run_id }}
  test_report:
    name: Generate Test Report
    runs-on: ubuntu-24.04
    needs: [flavor_version_data]
    if: always()
    permissions:
      actions: write
      checks: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # pin@v5.0.0
        with:
          submodules: true

      - name: Download all test artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # pin@v5.0.0
        with:
          pattern: "*-test-*"
          path: test-artifacts
          merge-multiple: true
        continue-on-error: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded test artifacts:"
          find test-artifacts -name "*.test.xml" -type f
          echo "Total XML files found: $(find test-artifacts -name "*.test.xml" -type f | wc -l)"

      - name: Set variables
        id: vars
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ needs.flavor_version_data.outputs.version }}';
            const commitId = '${{ needs.flavor_version_data.outputs.commit_id }}';
            const commitShort = commitId.substring(0, 8);
            const commitUrl = `${{ github.server_url }}/${{ github.repository }}/commit/${commitId}`;
            const title = `Garden Linux ${version}-<a href="${commitUrl}">${commitShort}</a> Test Results`;

            core.setOutput('version', version);
            core.setOutput('commit_id', commitId);
            core.setOutput('commit_short', commitShort);
            core.setOutput('commit_url', commitUrl);
            core.setOutput('title', title);

      - name: Generate Test Report
        uses: gardenlinux/pytest-multi-results-action@8fc9cd734e3bfac0057ca43d70cd561b5f4d52bb
        if: always()
        with:
          files: |
            test-artifacts/**/*.test.xml
          title: ${{ steps.vars.outputs.title }}
          summary: true
          result-types: "skipped,passed,failed,error"
          fail-on-empty: false
          metadata-fields: "Artifact,Type,Namespace"
          metadata-field-mapping: '{"Namespace": "Namespace", "Type": "Type", "Artifact": "Artifact"}'

      - name: Upload report artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # pin@v4.6.2
        if: always()
        with:
          name: test-report
          path: |
            test-artifacts/*.test.xml
          retention-days: 30
  test_ng_report:
    name: Generate Test-NG Report
    runs-on: ubuntu-24.04
    needs: [flavor_version_data]
    if: always()
    permissions:
      actions: write
      checks: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # pin@v5.0.0
        with:
          submodules: true

      - name: Download all test artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # pin@v5.0.0
        with:
          pattern: "*-test-ng-*"
          path: test-artifacts
          merge-multiple: true
        continue-on-error: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded test artifacts:"
          find test-artifacts -name "*.test-ng.xml" -type f
          echo "Total XML files found: $(find test-artifacts -name "*.test-ng.xml" -type f | wc -l)"

      - name: Set variables
        id: vars
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ needs.flavor_version_data.outputs.version }}';
            const commitId = '${{ needs.flavor_version_data.outputs.commit_id }}';
            const commitShort = commitId.substring(0, 8);
            const commitUrl = `${{ github.server_url }}/${{ github.repository }}/commit/${commitId}`;
            const title = `Garden Linux ${version}-<a href="${commitUrl}">${commitShort}</a> Test-NG Results`;

            core.setOutput('version', version);
            core.setOutput('commit_id', commitId);
            core.setOutput('commit_short', commitShort);
            core.setOutput('commit_url', commitUrl);
            core.setOutput('title', title);

      - name: Generate Test Report
        uses: gardenlinux/pytest-multi-results-action@8fc9cd734e3bfac0057ca43d70cd561b5f4d52bb
        if: always()
        with:
          files: |
            test-artifacts/**/*.test-ng.xml
          title: ${{ steps.vars.outputs.title }}
          summary: true
          result-types: "skipped,passed,failed,error"
          fail-on-empty: false
          metadata-fields: "Artifact,Type,Namespace"
          metadata-field-mapping: '{"Namespace": "Namespace", "Type": "Type", "Artifact": "Artifact"}'

      - name: Upload report artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # pin@v4.6.2
        if: always()
        with:
          name: test-ng-report
          path: |
            test-artifacts/*.test-ng.xml
          retention-days: 30
