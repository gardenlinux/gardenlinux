# @TODO: Replace with safe OCI manifast handling variant
name: publish_oci_containers
on:
  workflow_call:
    inputs:
      run_id:
        type: string
        required: true
      commit_id:
        type: string
        required: true
      version:
        type: string
        required: true
      target:
        type: string
        required: true
      flavors_matrix:
        type: string
        required: true
      bare_flavors_matrix:
        type: string
        default: '{"include":[]}'
      original_workflow_name:
        type: string
        default: ""
    secrets:
      aws_role:
        required: true
      aws_session:
        required: true
      aws_region:
        required: true
      oci_kms_arn:
        required: true
jobs:
  determine_environment:
    name: Determine release environment and repository for ${{ inputs.target }}
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_values.outputs.environment }}
      repository: ${{ steps.set_values.outputs.repository }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
      - name: Set environment and repository
        id: set_values
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const gitHubLib = await import("${{ github.workspace }}/.github/workflows/github.mjs");

            core.setOutput("environment", gitHubLib.getGitHubSigningEnvironmentFromTarget("${{ inputs.target }}"));
            const repository = gitHubLib.getGHCRRepositoryFromTarget("${{ inputs.target }}");

            if (repository == "") {
              core.setFailed("Invalid release target ${{ inputs.target }}");
              return false;
            }

            core.setOutput("repository", repository);

            return true;
  container:
    needs: determine_environment
    name: Publish container images
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    env:
      CNAME_AMD64: ""
      CNAME_ARM64: ""
      CONTAINER_BASE_NAME: ""
    permissions:
      packages: write
    strategy:
      matrix:
        flavor:
        - bare-libc
        - bare-nodejs
        - bare-python
        - bare-sapmachine
        - container
        - container-pythonDev
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
      - name: Install python-gardenlinux-lib
        uses: gardenlinux/python-gardenlinux-lib/.github/actions/setup@051a88b91cd1e13eeff171f3351a57bd2accbf6f # 0.10.8
      - name: Set flavor version reference
        run: |
          echo "${{ inputs.commit_id }}" | tee COMMIT
          echo "${{ inputs.version }}" | tee VERSION
      - name: Set CNAMEs and container base name
        run: |
          echo "CNAME_AMD64=$(gl-features-parse --cname ${{ matrix.flavor }}-amd64 cname)" | tee -a "$GITHUB_ENV"
          echo "CNAME_ARM64=$(gl-features-parse --cname ${{ matrix.flavor }}-arm64 cname)" | tee -a "$GITHUB_ENV"
          echo "CONTAINER_BASE_NAME=$(gl-features-parse --cname ${{ matrix.flavor }} --arch amd64 container_name)" | tee -a "$GITHUB_ENV"
      - id: build_cache
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # pin@v7.0.0
        with:
          name: build-${{ matrix.flavor }}-*
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id }}
      - if: ${{ steps.build_cache.outputs.cache-hit == 'true' }}
        name: Publish container images
        run: |
          if [ "${{ inputs.original_workflow_name }}" = "nightly" ]; then
            is_nightly=true
          else
            is_nightly=false
          fi
          version=$(cat VERSION)

          podman login -u token -p ${{ github.token }} ghcr.io
          tar xzv < "${CNAME_AMD64}.tar.gz"
          image="$(podman load < ${CNAME_AMD64}.oci | awk '{ print $NF }')"

          # Tagging for amd64 nightly
          if [ $is_nightly = true ]; then
            podman tag "$image" ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:amd64-nightly
            podman push ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:amd64-nightly
          fi

          # Tagging for amd64 with version
          podman tag "$image" ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:amd64-${version}
          podman push ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:amd64-${version}

          tar xzv < "${CNAME_ARM64}.tar.gz"
          image="$(podman load < ${CNAME_ARM64}.oci | awk '{ print $NF }')"

          # Tagging for arm64 nightly
          if [ $is_nightly = true ]; then
            podman tag "$image" ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:arm64-nightly
            podman push ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:arm64-nightly
          fi

          # Tagging for arm64 with version
          podman tag "$image" ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:arm64-${version}
          podman push ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:arm64-${version}

          # Creating and pushing manifest for nightly
          if [ $is_nightly = true ]; then
            podman manifest create ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:nightly
            podman manifest add ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:nightly ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:amd64-nightly
            podman manifest add ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:nightly ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:arm64-nightly
            podman manifest push ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:nightly
          fi

          # Creating and pushing manifest for version tag
          podman manifest create ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:${version}
          podman manifest add ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:${version} ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:amd64-${version}
          podman manifest add ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:${version} ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:arm64-${version}
          podman manifest push ${{ needs.determine_environment.outputs.repository }}/${CONTAINER_BASE_NAME}:${version}
  push_flavors:
    needs: determine_environment
    name: Publish flavors
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    env:
      CNAME: ""
    permissions:
      id-token: write
      packages: write
    environment: ${{ needs.determine_environment.outputs.environment }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.flavors_matrix) }}
      max-parallel: 8
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
      - uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # pin@v4
        with:
          role-to-assume: ${{ secrets.aws_role }}
          role-session-name: ${{ secrets.aws_session }}
          aws-region: ${{ secrets.aws_region }}
      - name: Install python-gardenlinux-lib
        uses: gardenlinux/python-gardenlinux-lib/.github/actions/setup@051a88b91cd1e13eeff171f3351a57bd2accbf6f # 0.10.8
      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: "v2.4.1"
      - name: Set flavor version reference
        run: |
          echo "${{ inputs.commit_id }}" | tee COMMIT
          echo "${{ inputs.version }}" | tee VERSION
      - name: Set CNAME
        run: |
          echo "CNAME=$(gl-features-parse --cname ${{ matrix.flavor }}-${{ matrix.arch }} cname)" | tee -a "$GITHUB_ENV"
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # pin@v7.0.0
        with:
          name: build-${{ matrix.flavor }}-${{ matrix.arch }}
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id }}
      - name: Push using the glcli util
        env:
          GL_CLI_REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GL_CLI_REGISTRY_USERNAME: ${{ github.repository_owner }}
        run: |
          mkdir "$CNAME"

          tar -C "$CNAME" -xzf "$CNAME.tar.gz"

          gl-oci push-manifest \
            --dir "${CNAME}" \
            --container ${{ needs.determine_environment.outputs.repository }} \
            --arch ${{ matrix.arch }} \
            --version ${{ inputs.version }} \
            --cname "${CNAME}" \
            --cosign_file digest.txt \
            --manifest_file "oci_manifest_entry_${CNAME}.json"
      - name: Sign the manifest
        run: |
          cat digest.txt
          docker login ghcr.io -u token -p ${{ github.token }}
          cosign sign -tlog-upload=false --key "awskms://kms.${{ secrets.aws_region }}.amazonaws.com/${{ secrets.oci_kms_arn }}" "${{ needs.determine_environment.outputs.repository }}@$(cat digest.txt)"
      - name: Verify signature
        run: |
          cosign verify --insecure-ignore-tlog=true --key "awskms://kms.${{ secrets.aws_region }}.amazonaws.com/${{ secrets.oci_kms_arn }}" "${{ needs.determine_environment.outputs.repository }}@$(cat digest.txt)"
      - uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # pin@v5.0.1
        with:
          path: oci_manifest_entry_${{ env.CNAME }}.json
          key: oci-manifest-${{ matrix.flavor }}-${{ matrix.arch }}-${{ github.run_id }}
  update_manifest_index:
    needs: [determine_environment, push_flavors]
    name: Update OCI manifest index
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    env:
      CNAME: ""
    permissions:
      id-token: write
      packages: write
      actions: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.flavors_matrix) }}
      max-parallel: 1
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
      - name: Install python-gardenlinux-lib
        uses: gardenlinux/python-gardenlinux-lib/.github/actions/setup@051a88b91cd1e13eeff171f3351a57bd2accbf6f # 0.10.8
      - name: Set flavor version reference
        run: |
          echo "${{ inputs.commit_id }}" | tee COMMIT
          echo "${{ inputs.version }}" | tee VERSION
      - name: Set CNAME
        run: |
          echo "CNAME=$(gl-features-parse --cname ${{ matrix.flavor }}-${{ matrix.arch }} cname)" | tee -a "$GITHUB_ENV"
      - uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # pin@v5.0.1
        with:
          path: oci_manifest_entry_${{ env.CNAME }}.json
          key: oci-manifest-${{ matrix.flavor }}-${{ matrix.arch }}-${{ github.run_id }}
      - name: Update index using glcli tool
        env:
          GL_CLI_REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GL_CLI_REGISTRY_USERNAME: ${{ github.repository_owner }}
        run: |
          mkdir manifests
          mv oci_manifest_entry_${CNAME}.json manifests/

          gl-oci update-index \
            --container ${{ needs.determine_environment.outputs.repository }} \
            --version ${{ inputs.version }} \
            --manifest_folder manifests

  build_tests_ng_container:
    name: Build tests-ng container (${{ matrix.arch }})
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
      - name: Download test distribution artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: test-distribution
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run_id }}
          path: .build
      - name: Determine version
        run: |
          version=$(bin/garden-version "${{ inputs.version }}")
          echo "VERSION=${version}" | tee -a "$GITHUB_ENV"
      - name: Build tests-ng container (${{ matrix.arch }})
        run: |
          set -euo pipefail
          arch=${{ matrix.arch }}
          echo "Building tests-ng for arch=$arch"
          repo="ghcr.io/${{ github.repository_owner }}/test-ng"
          podman build --arch ${arch} --build-context dist_ctx=.build -t ${repo}:${arch}-${VERSION} tests-ng/util/container
          podman save --format oci-archive ${repo}:${arch}-${VERSION} > tests-ng-container_${arch}.oci
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: tests-ng-container-${{ matrix.arch }}
          path: tests-ng-container_${{ matrix.arch }}.oci
          if-no-files-found: error

  publish_tests_ng:
    name: Publish tests-ng container
    needs: build_tests_ng_container
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
      - name: Download built tests-ng archives
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          pattern: tests-ng-container-*
          merge-multiple: true
      - name: Load OCI archives
        run: |
          for oci in *.oci; do
            podman load -i "${oci}"
            rm -f "${oci}"
          done
      - name: Publish tests-ng images and manifest
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ inputs.original_workflow_name }}" = "nightly" ]; then
            is_nightly=true
          else
            is_nightly=false
          fi

          version=$(bin/garden-version "${{ inputs.version }}")

          podman login -u token -p ${GITHUB_TOKEN} ghcr.io

          # Push amd64 and arm64 images
          podman push ghcr.io/${{ github.repository_owner }}/test-ng:amd64-${version}
          podman push ghcr.io/${{ github.repository_owner }}/test-ng:arm64-${version}

          if [ "$is_nightly" = true ]; then
            podman tag ghcr.io/${{ github.repository_owner }}/test-ng:amd64-${version} ghcr.io/${{ github.repository_owner }}/test-ng:amd64-nightly
            podman tag ghcr.io/${{ github.repository_owner }}/test-ng:arm64-${version} ghcr.io/${{ github.repository_owner }}/test-ng:arm64-nightly
            podman push ghcr.io/${{ github.repository_owner }}/test-ng:amd64-nightly
            podman push ghcr.io/${{ github.repository_owner }}/test-ng:arm64-nightly
          fi

          # Create and push manifests
          if [ "$is_nightly" = true ]; then
            podman manifest create ghcr.io/${{ github.repository_owner }}/test-ng:nightly
            podman manifest add ghcr.io/${{ github.repository_owner }}/test-ng:nightly ghcr.io/${{ github.repository_owner }}/test-ng:amd64-nightly
            podman manifest add ghcr.io/${{ github.repository_owner }}/test-ng:nightly ghcr.io/${{ github.repository_owner }}/test-ng:arm64-nightly
            podman manifest push ghcr.io/${{ github.repository_owner }}/test-ng:nightly
          fi

          podman manifest create ghcr.io/${{ github.repository_owner }}/test-ng:${version}
          podman manifest add ghcr.io/${{ github.repository_owner }}/test-ng:${version} ghcr.io/${{ github.repository_owner }}/test-ng:amd64-${version}
          podman manifest add ghcr.io/${{ github.repository_owner }}/test-ng:${version} ghcr.io/${{ github.repository_owner }}/test-ng:arm64-${version}
          podman manifest push ghcr.io/${{ github.repository_owner }}/test-ng:${version}
