name: nightly
on: [ push ]
    #    - cron: '0 6 * * *'
jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      version: now
  build_container:
    uses: ./.github/workflows/build-container.yml
  gcp_tests:
    needs: [ build, build_container ]
    permissions:
      id-token: write
      packages: write
    uses: ./.github/workflows/gcp_tests.yml
    secrets:
      gcp_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      gcp_service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      gcp_project: ${{ secrets.GCP_PROJECT }}
      gcp_region: ${{ secrets.GCP_REGION }}
      gcp_zone: ${{ secrets.GCP_ZONE }}
  upload_to_s3:
    name: upload to S3
    # last platform tests in chain of jobs above
    needs: gcp_tests
    permissions:
      id-token: write
    uses: ./.github/workflows/upload_to_s3.yml
    secrets:
      bucket: ${{ secrets.AWS_S3_BUCKET }}
      region: ${{ secrets.AWS_REGION }}
      role: ${{ secrets.AWS_IAM_ROLE }}
      session: ${{ secrets.AWS_OIDC_SESSION }}
