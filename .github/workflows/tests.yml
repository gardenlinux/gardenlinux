name: tests
on:
  # triggered by other workflows
  workflow_call:
    inputs:
      flavors_matrix:
        description: "Generated GitHub workflow flavors matrix"
        type: string
        required: true
      test_types:
        description: "Types of tests to execute (comma-separated: chroot,qemu,cloud,oci)"
        type: string
        default: "chroot,qemu"
      bare_flavors_matrix:
        description: "Generated GitHub workflow flavors matrix for bare flavors"
        type: string
        default: '{"include":[]}'
    secrets:
      gcp_identity_provider:
        required: false
      gcp_service_account:
        required: false
      gcp_project_id:
        required: false
      gcp_region:
        required: false
      gcp_zone:
        required: false
      aws_role:
        required: false
      aws_session:
        required: false
      aws_region:
        required: false
      aws_s3_bucket:
        required: false
      az_client_id:
        required: false
      az_tenant_id:
        required: false
      az_subscription_id:
        required: false
      ccc_credentials:
        required: false
      tf_encryption:
        required: false
jobs:
  chroot_test_flavors_supported_matrix:
    name: Generate flavors matrix for chroot test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: "--no-arch --json-by-arch --test"
  qemu_test_flavors_supported_matrix:
    name: Generate flavors matrix for qemu test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: "--no-arch --json-by-arch --test --exclude vmware-*"
  platform_test_flavors_supported_matrix:
    name: Generate flavors matrix for platform-test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: "--no-arch --json-by-arch --test-platform"
  bare_flavors_supported_matrix:
    name: Generate flavors matrix for bare flavors test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: '--include-only "bare-*" --no-arch --json-by-arch --test'
  determine_test_settings:
    needs:
      [
        chroot_test_flavors_supported_matrix,
        qemu_test_flavors_supported_matrix,
        platform_test_flavors_supported_matrix,
        bare_flavors_supported_matrix,
      ]
    name: Determine test settings
    runs-on: "ubuntu-24.04"
    defaults:
      run:
        shell: bash
    outputs:
      bare_flavors_matrix: ${{ steps.test_environments.outputs.bare_flavors_matrix }}
      bare_flavors_tests: ${{ steps.test_environments.outputs.bare_flavors_tests }}
      chroot_test_flavors_matrix: ${{ steps.test_environments.outputs.chroot_test_flavors_matrix }}
      chroot_tests: ${{ steps.test_environments.outputs.chroot_tests }}
      platform_test_flavors_matrix: ${{ steps.test_environments.outputs.platform_test_flavors_matrix }}
      platform_test: ${{ steps.test_environments.outputs.platform_tests }}
      qemu_test_flavors_matrix: ${{ steps.test_environments.outputs.qemu_test_flavors_matrix }}
      qemu_tests: ${{ steps.test_environments.outputs.qemu_tests }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # pin@v5.0.0
        with:
          submodules: true
      - id: test_environments
        name: Determine test environments
        uses: actions/github-script@v8
        with:
          script: |
            const gitHubLib = await import("${{ github.workspace }}/.github/workflows/github.mjs");

            const testsEnvsEnabled = gitHubLib.getTestEnvironmentsEnabled("${{ inputs.test_types }}");

            // chroot_test_flavors_matrix
            if (testsEnvsEnabled.includes("chroot")) {
              const matrix = gitHubLib.intersectFlavorsMatrix(
                ${{ inputs.flavors_matrix }},
                ${{ needs.chroot_test_flavors_supported_matrix.outputs.matrix }}
              );

              const isEnabled = !gitHubLib.isMatrixEmpty(matrix);
              core.setOutput("chroot_tests", isEnabled);

              if (isEnabled) {
                core.setOutput("chroot_test_flavors_matrix", matrix);
              }
            }

            // qemu_test_flavors_matrix
            if (testsEnvsEnabled.includes("qemu")) {
              const matrix = gitHubLib.intersectFlavorsMatrix(
                ${{ inputs.flavors_matrix }},
                ${{ needs.qemu_test_flavors_supported_matrix.outputs.matrix }}
              );

              const isEnabled = !gitHubLib.isMatrixEmpty(matrix);
              core.setOutput("qemu_tests", isEnabled);

              if (isEnabled) {
                core.setOutput("qemu_test_flavors_matrix", matrix);
              }
            }

            // platform_test_flavors_matrix
            if (testsEnvsEnabled.includes("cloud")) {
              const matrix = gitHubLib.intersectFlavorsMatrix(
                ${{ inputs.flavors_matrix }},
                ${{ needs.platform_test_flavors_supported_matrix.outputs.matrix }}
              );

              const isEnabled = !gitHubLib.isMatrixEmpty(matrix);
              core.setOutput("platform_tests", isEnabled);

              if (isEnabled) {
                core.setOutput("platform_test_flavors_matrix", matrix);
              }
            }

            // bare_flavors_matrix
            if (testsEnvsEnabled.includes("oci")) {
              const matrix = gitHubLib.intersectFlavorsMatrix(
                ${{ inputs.bare_flavors_matrix }},
                ${{ needs.bare_flavors_supported_matrix.outputs.matrix }}
              );

              const isEnabled = !gitHubLib.isMatrixEmpty(matrix);
              core.setOutput("bare_flavors_tests", isEnabled);

              if (isEnabled) {
                core.setOutput("bare_flavors_matrix", matrix);
              }
            }
  ## test-ng start
  test_flavors_chroot_ng:
    needs: determine_test_settings
    name: Test-NG chroot flavors
    uses: ./.github/workflows/test_flavor_chroot_ng.yml
    if: ${{ needs.determine_test_settings.outputs.chroot_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.chroot_test_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    permissions:
      actions: write
  test_flavors_qemu:
    needs: determine_test_settings
    name: Test-NG QEMU flavors
    uses: ./.github/workflows/test_flavor_qemu.yml
    if: ${{ needs.determine_test_settings.outputs.qemu_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.qemu_test_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    permissions:
      actions: write
  test_flavors_cloud_ng:
    needs: [determine_test_settings, test_flavors_qemu]
    name: Test-NG cloud flavors
    uses: ./.github/workflows/test_flavor_cloud_ng.yml
    if: |
      ${{
        always()
        && (needs.test_flavors_qemu.result == 'success' || needs.test_flavors_qemu.result == 'skipped')
        && needs.determine_test_settings.outputs.platform_tests == 'true'
      }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.platform_test_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    secrets: inherit
    permissions:
      id-token: write
      actions: write
  test_flavors_oci_ng:
    needs: determine_test_settings
    name: Test-NG OCI flavors
    uses: ./.github/workflows/test_flavor_oci_ng.yml
    if: ${{ needs.determine_test_settings.outputs.bare_flavors_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.bare_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    permissions:
      actions: write
  ## test-ng end
  test_flavors_chroot:
    needs: determine_test_settings
    name: Test-NG chroot flavors
    uses: ./.github/workflows/test_flavor_chroot.yml
    if: ${{ needs.determine_test_settings.outputs.chroot_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.chroot_test_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    permissions:
      actions: write
  test_flavors_cloud:
    needs: [determine_test_settings, test_flavors_qemu]
    name: Test cloud flavors
    uses: ./.github/workflows/test_flavor_cloud.yml
    if: |
      ${{
        always()
        && (needs.test_flavors_qemu.result == 'success' || needs.test_flavors_qemu.result == 'skipped')
        && needs.determine_test_settings.outputs.platform_tests == 'true'
      }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.platform_test_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    secrets: inherit
    permissions:
      id-token: write
      actions: write
  test_flavors_oci:
    needs: determine_test_settings
    name: Test OCI flavors
    uses: ./.github/workflows/test_flavor_oci.yml
    if: ${{ needs.determine_test_settings.outputs.bare_flavors_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_test_settings.outputs.bare_flavors_matrix) }}
    with:
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    permissions:
      actions: write
  test_report:
    needs:
      - test_flavors_chroot_ng
      - test_flavors_qemu
      - test_flavors_cloud_ng
      - test_flavors_oci_ng
      - test_flavors_chroot
      - test_flavors_cloud
      - test_flavors_oci
    name: Generate Test Report
    if: always()
    uses: ./.github/workflows/test_report.yml
    permissions:
      actions: write
      checks: write
    with:
      test_jobs: "test_flavors_chroot_ng,test_flavors_qemu,test_flavors_cloud_ng,test_flavors_oci_ng,test_flavors_chroot,test_flavors_cloud,test_flavors_oci"
