name: tests
on:
  # triggered by other workflows
  workflow_call:
    inputs:
      version:
        description: "Garden Linux version"
        type: string
        required: true
      flavors_matrix:
        description: "Generated GitHub workflow flavors matrix"
        type: string
        required: true
      chroot_test:
        description: "Execute chrooted tests"
        type: boolean
        default: true
      qemu_test:
        description: "Execute qemu tests"
        type: boolean
        default: true
      cloud_test:
        description: "Execute cloud tests"
        type: boolean
        default: true
      platform_test:
        description: "Execute platform tests"
        type: boolean
        default: false
      bare_flavors_matrix:
        description: "Generated GitHub workflow flavors matrix for bare flavors"
        type: string
        default: '{"include":[]}'
      bare_test:
        description: "Execute bare flavors container tests"
        type: boolean
        default: false
    secrets:
      gcp_identity_provider:
        required: false
      gcp_service_account:
        required: false
      gcp_project_id:
        required: false
      gcp_region:
        required: false
      gcp_zone:
        required: false
      aws_role:
        required: false
      aws_session:
        required: false
      aws_region:
        required: false
      aws_s3_bucket:
        required: false
      az_client_id:
        required: false
      az_tenant_id:
        required: false
      az_subscription_id:
        required: false
      ccc_credentials:
        required: false
      tf_encryption:
        required: false
jobs:
  chroot_test_flavors_supported_matrix:
    name: Generate flavors matrix for chroot test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: "--no-arch --json-by-arch --test"
  platform_test_flavors_supported_matrix:
    name: Generate flavors matrix for platform-test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: "--no-arch --json-by-arch --test-platform"
  test_bare_flavors_supported_matrix:
    name: Generate flavors matrix for bare flavors test
    uses: ./.github/workflows/build_flavors_matrix.yml
    with:
      flags: '--include-only "bare-*" --no-arch --json-by-arch --test'
  intersect_matrices:
    needs:
      [
        chroot_test_flavors_supported_matrix,
        platform_test_flavors_supported_matrix,
        test_bare_flavors_supported_matrix,
      ]
    name: Intersect test matrices
    runs-on: "ubuntu-24.04"
    defaults:
      run:
        shell: bash
    outputs:
      chroot_test_flavors_matrix: ${{ steps.matrices.outputs.chroot_test_flavors_matrix }}
      platform_test_flavors_matrix: ${{ steps.matrices.outputs.platform_test_flavors_matrix }}
      test_bare_flavors_matrix: ${{ steps.matrices.outputs.test_bare_flavors_matrix }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # pin@v5.0.0
        with:
          submodules: true
      - id: matrices
        name: Calculate matrices
        uses: actions/github-script@v8
        with:
          script: |
            const gitHubLib = await import("${{ github.workspace }}/.github/workflows/github.mjs");

            // chroot_test_flavors_matrix
            let matrix = gitHubLib.intersectFlavorsMatrix(
              ${{ inputs.flavors_matrix }},
              ${{ needs.chroot_test_flavors_supported_matrix.outputs.matrix }}
            );

            core.setOutput("chroot_test_flavors_matrix", matrix);

            // platform_test_flavors_matrix
            matrix = gitHubLib.intersectFlavorsMatrix(
              ${{ inputs.flavors_matrix }},
              ${{ needs.platform_test_flavors_supported_matrix.outputs.matrix }}
            );

            core.setOutput("platform_test_flavors_matrix", matrix);

            // test_bare_flavors_matrix
            matrix = gitHubLib.intersectFlavorsMatrix(
              ${{ inputs.bare_flavors_matrix }},
              ${{ needs.test_bare_flavors_supported_matrix.outputs.matrix }}
            );

            core.setOutput("test_bare_flavors_matrix", matrix);
  ## test-ng start
  test_distribution_build:
    name: Build and Cache Test Distribution
    uses: ./.github/workflows/build_test_dist.yml
  test_flavors_chrooted:
    needs: [intersect_matrices, test_distribution_build]
    name: Test flavors chrooted
    uses: ./.github/workflows/test_flavor_chrooted.yml
    if: ${{ needs.intersect_matrices.outputs.chroot_test_flavors_matrix != '{"include":[]}' && inputs.chroot_test == true }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.intersect_matrices.outputs.chroot_test_flavors_matrix) }}
    with:
      version: ${{ inputs.version }}
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    permissions:
      actions: write      
  test_flavors_qemu:
    needs: [intersect_matrices, test_distribution_build]
    name: Test flavors QEMU
    uses: ./.github/workflows/test_flavor_qemu.yml
    if: ${{ needs.intersect_matrices.outputs.platform_test_flavors_matrix != '{"include":[]}' && inputs.qemu_test == true }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.intersect_matrices.outputs.platform_test_flavors_matrix) }}
    with:
      version: ${{ inputs.version }}
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
  test_flavors_cloud:
    needs: [intersect_matrices, test_distribution_build]
    name: Test flavors Cloud
    uses: ./.github/workflows/test_flavor_cloud.yml
    if: ${{ needs.intersect_matrices.outputs.platform_test_flavors_matrix != '{"include":[]}' && inputs.cloud_test == true }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.intersect_matrices.outputs.platform_test_flavors_matrix) }}
    with:
      version: ${{ inputs.version }}
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    secrets: inherit
  ## test-ng end
  test_platform_flavors:
    needs: intersect_matrices
    name: Test platform flavors
    uses: ./.github/workflows/test_platform_flavor.yml
    if: ${{ needs.intersect_matrices.outputs.platform_test_flavors_matrix != '{"include":[]}' && inputs.platform_test == true }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.intersect_matrices.outputs.platform_test_flavors_matrix) }}
    with:
      version: ${{ inputs.version }}
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
    secrets: inherit
    permissions:
      id-token: write
      actions: write
  test_bare_flavors:
    needs: intersect_matrices
    name: Test bare flavors
    uses: ./.github/workflows/test_bare_flavor.yml
    if: ${{ needs.intersect_matrices.outputs.test_bare_flavors_matrix != '{"include":[]}' && inputs.bare_test == true }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.intersect_matrices.outputs.test_bare_flavors_matrix) }}
    with:
      version: ${{ inputs.version }}
      arch: ${{ matrix.arch }}
      flavor: ${{ matrix.flavor }}
