name: tests
on:
  workflow_call:
jobs:
  tests:
    name: test
    runs-on: ec2-gardenlinux-amd64
    strategy:
      matrix:
        architecture: [ amd64, arm64 ]
        target: [ gcp ]
        modifier: [ "" ]
        exclude:
          - architecture: arm64
            target: gcp
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v2
        with:
          name: build-${{ matrix.architecture }}-${{ matrix.target }}${{ matrix.modifier }}

      - if: ${{ matrix.target == 'gcp' }}
        id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: google-github-actions/auth@v0
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER}}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - if: ${{ matrix.target == 'gcp' }}
        name: start platform test for gcp
        run: .github/workflows/gcp_platform_tests.sh "build-${{ matrix.architecture }}-${{ matrix.target }}${{ matrix.modifier }}" 

