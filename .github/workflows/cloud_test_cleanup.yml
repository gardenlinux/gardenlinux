name: Cloud Test Cleanup
on:
  schedule:
    - cron: "0 4 * * *" # Run daily at 4 AM UTC
  # manual trigger
  workflow_dispatch:
jobs:
  collect_workspaces:
    name: Collect Workspaces to Cleanup
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
    environment: oidc_platform_tests
    outputs:
      matrix_test: ${{ steps.set-matrix.outputs.matrix_test }}
    steps:
      - id: "auth_aws"
        name: "Authenticate to AWS"
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # pin@v4
        with:
          role-to-assume: ${{ secrets.AWS_TESTS_IAM_ROLE }}
          role-session-name: ${{ secrets.AWS_TESTS_OIDC_SESSION }}
          aws-region: ${{ secrets.AWS_TESTS_REGION }}

      - name: Find Old OpenTofu Workspaces
        id: set-matrix
        run: |
          # List objects older than 1 day and extract workspace names
          ALL_WORKSPACES=$(aws s3api list-objects-v2 \
            --bucket gardenlinux-dev-gh-actions-tfstate \
            --query "Contents[?LastModified<='`date -d '1 day ago' --iso-8601=seconds`'].Key" \
            --output json | jq -r '.[]' | grep "^env:/" | \
            sed -E 's|env:/([^/]+)/terraform.tfstate|\1|' | grep -v ^tfstate | sort -u)

          TEST_WORKSPACES=$(echo "$ALL_WORKSPACES" | grep "^test-" | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix_test=${TEST_WORKSPACES}" >> $GITHUB_OUTPUT

  cleanup:
    needs: collect_workspaces
    if: ${{ needs.collect_workspaces.outputs.matrix_test != '[]' && needs.collect_workspaces.outputs.matrix_test != '' }}
    name: Cleanup Test Workspaces
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
    environment: oidc_platform_tests

    strategy:
      fail-fast: false
      matrix:
        workspace: ${{ fromJson(needs.collect_workspaces.outputs.matrix_test) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: true
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y retry
      - name: "Authenticate to Google Cloud"
        if: ${{ contains(matrix.workspace, '-gcp-') }}
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          cleanup_credentials: true
          export_environment_variables: true
      - name: Set GCP environment
        if: ${{ contains(matrix.workspace, '-gcp-') }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            // tf provider vars
            core.exportVariable("GOOGLE_PROJECT", "${{ secrets.GCP_PROJECT }}");
            core.exportVariable("GOOGLE_REGION", "${{ secrets.GCP_REGION }}");
            core.exportVariable("GOOGLE_ZONE", "${{ secrets.GCP_ZONE }}");
      - id: "auth_aws"
        name: "Authenticate to AWS (S3 backend)"
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # pin@v4
        with:
          role-to-assume: ${{ secrets.AWS_TESTS_IAM_ROLE }}
          role-session-name: ${{ secrets.AWS_TESTS_OIDC_SESSION }}
          aws-region: ${{ secrets.aws_region }}
          output-credentials: true
      - name: Set AWS environment
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            // tf provider auth
            core.setSecret("${{ steps.auth_aws.outputs.aws-access-key-id }}");
            core.exportVariable("AWS_ACCESS_KEY_ID", "${{ steps.auth_aws.outputs.aws-access-key-id }}");
            core.setSecret("${{ steps.auth_aws.outputs.aws-secret-access-key }}");
            core.exportVariable("AWS_SECRET_ACCESS_KEY", "${{ steps.auth_aws.outputs.aws-secret-access-key }}");
            core.setSecret("${{ steps.auth_aws.outputs.aws-session-token }}");
            core.exportVariable("AWS_SESSION_TOKEN", "${{ steps.auth_aws.outputs.aws-session-token }}");
            // tf provider vars
            core.exportVariable("AWS_REGION", "${{ secrets.aws_region }}");
      - id: "auth_azure"
        if: ${{ contains(matrix.workspace, '-azure-') }}
        name: "Authenticate to Azure"
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # pin@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Set Azure environment
        if: ${{ contains(matrix.workspace, '-azure-') }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            // tf provider auth
            core.exportVariable("ARM_USE_OIDC", "true");
            core.exportVariable("AZURE_CONFIG_DIR", "$RUNNER_TEMP/azure_config_dir");
            core.setSecret("${{ secrets.AZURE_CLIENT_ID }}");
            core.exportVariable("ARM_CLIENT_ID", "${{ secrets.AZURE_CLIENT_ID }}");
            core.setSecret("${{ secrets.AZURE_SUBSCRIPTION_ID }}");
            core.exportVariable("ARM_SUBSCRIPTION_ID", "${{ secrets.AZURE_SUBSCRIPTION_ID }}");
            core.setSecret("${{ secrets.AZURE_TENANT_ID }}");
            core.exportVariable("ARM_TENANT_ID", "${{ secrets.AZURE_TENANT_ID }}");
      - id: "auth_alicloud"
        if: ${{ startsWith(inputs.flavor, 'ali-') }}
        name: "Authenticate to Alicloud"
        uses: aliyun/configure-aliyun-credentials-action@b347e60e64028a4d567a8f31ca42e1b0706c3c99 # v1.0.7
        with:
          role-to-assume: ${{ secrets.alibaba_cloud_role_arn }}
          oidc-provider-arn: ${{ secrets.alibaba_cloud_oidc_provider_arn }}
          role-session-expiration: 21600
      - name: "Set Alicloud platform-test environment"
        if: ${{ startsWith(inputs.flavor, 'ali-') }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            // tf provider vars
            core.exportVariable("ALIBABA_CLOUD_REGION", "${{ secrets.alibaba_cloud_region }}");
      - name: Set additional OpenTofu variables
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const tfEncryption = Buffer.from("${{ secrets.TF_ENCRYPTION }}", 'base64').toString('utf-8');
            core.setSecret(tfEncryption);
            core.exportVariable("TF_ENCRYPTION", tfEncryption);

            core.exportVariable("WORKSPACE", "${{ matrix.workspace }}");
            const workspace = "${{ matrix.workspace }}";

            // Extract the image name by removing test prefix and run info
            // Workspace format: test-[run_id]-[run_number]-[cloud]-[flavor]...
            // Remove test- and run ID/number to get: [cloud]-[flavor]-[version]-...-[seed]
            let imageName = workspace.replace(/^test-\d+-\d+-/, "");
            core.exportVariable("IMAGE_NAME", imageName);

            // Extract cloud provider from image name (first component)
            const cloud = imageName.split('-')[0];
            core.exportVariable("CLOUD", cloud);
      - name: Destroy OpenTofu Resources and delete workspaces
        run: |
          echo "Processing workspace: ${WORKSPACE}"
          echo "Processing cloud: ${CLOUD}"

          cd tests/util/tf
          export TOFUENV_GITHUB_TOKEN="${GITHUB_TOKEN:-}"
          source ../install_tofu.sh
          install_tofu "$PWD"

          # ssh key generation (if missing)
          test -f ~/.ssh/id_ed25519 || ssh-keygen -t ed25519 -P "" -f ~/.ssh/id_ed25519
          # secureboot certificate files
          mkdir -p cert
          touch cert/secureboot.db.crt cert/secureboot.pk.der cert/secureboot.db.der cert/secureboot.kek.der cert/secureboot.aws-efivars

          # Create minimal tfvars
          cat > empty.tfvars <<EOF
            root_disk_path        = "empty.raw"
            test_disk_path        = "empty.raw"
            user_data_script_path = "empty.sh"
            existing_root_disk    = ""
            cloud_provider        = "${CLOUD}"
            image_requirements    = {
              arch = "amd64"
              uefi = false
              secureboot = false
              tpm2 = false
            }
          EOF

          # Create non-empty placeholder artifacts required by tofu destroy
          cp empty.tfvars empty.raw
          cp empty.tfvars empty.sh

          # Enable remote state S3 backend and init
          if [ ! -f backend.tf ]; then
            cp backend.tf.github backend.tf
          fi
          tofu init -input=false -reconfigure -var-file empty.tfvars

          if ! tofu workspace select "${WORKSPACE}"; then
            echo "Failed to select workspace ${WORKSPACE}, skipping..."
            exit 0
          fi

          tofu destroy -var-file empty.tfvars -auto-approve || true
          tofu workspace select default
          tofu workspace delete "${WORKSPACE}" || true
  cleanup_retry:
    needs: cleanup
    if: ${{ failure() && needs.cleanup.result == 'failure' }}
    name: "Retry checkpoint: Cleanup"
    runs-on: ubuntu-24.04
    permissions:
      actions: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Retry failed cleanup
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const gitHubLib = await import("${{ github.workspace }}/.github/workflows/github.mjs");

            const gitHubRef = "${{ github.head_ref == '' && github.ref_name || github.head_ref }}";
            return await gitHubLib.dispatchRetryWorkflow(core, github.rest.actions, context, gitHubRef, 5);
