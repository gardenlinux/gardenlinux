name: build_kmodbuild_container
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-build-kmodbuild-container
  cancel-in-progress: true
on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
jobs:
  kmodbuild_container:
    name: Build kernel module build dev container (${{ matrix.arch }})
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-latest-arm' || 'ubuntu-latest' }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        arch: [ amd64, arm64 ]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # pin@v4.1.1
        with:
          submodules: true
      - uses: ./.github/actions/setup
        with:
          arch: ${{ matrix.arch }}
      - name: Get container versions
        id: versions
        run: |
          version="$(bin/garden-version "${{ inputs.version }}")"

          if [ "$version" == "today" ]; then
            version="$(bin/garden-version now)"
          fi

          snapshot="$(gh api "/repos/gardenlinux/repo/contents/.container?ref=$version" | jq -r '.content' | base64 -d)"

          echo -e "base=ghcr.io/${{ github.repository }}:$version" | tee -a "$GITHUB_OUTPUT"
          echo -e "snapshot=$snapshot" | tee -a "$GITHUB_OUTPUT"
          echo -e "version=$version" | tee -a "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Build kernel module build dev container (${{ matrix.arch }})
        run: |
          podman login -u token -p ${{ github.token }} ghcr.io

          base='${{ steps.versions.outputs.base }}'
          snapshot='${{ steps.versions.outputs.snapshot }}'
          version='${{ steps.versions.outputs.version }}'

          podman pull --arch ${{ matrix.arch }} "$base"
          podman pull --arch ${{ matrix.arch }} "$snapshot"
          podman build --arch ${{ matrix.arch }} --build-arg base="$base" --build-arg snapshot="$snapshot" -t ghcr.io/${{ github.repository }}/kmodbuild:${{ matrix.arch }}-${version} images/kmodbuild

          podman save --format oci-archive ghcr.io/${{ github.repository }}/kmodbuild:${{ matrix.arch }}-${version} > kmodbuild_container_${{ matrix.arch }}.oci
      - uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # pin@v4.4.3
        with:
          name: kmodbuild-container-${{ matrix.arch }}
          path: kmodbuild_container_${{ matrix.arch }}.oci
          if-no-files-found: error
