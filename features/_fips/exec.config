#!/usr/bin/env bash
set -Eeuo pipefail

openssl fipsinstall -out /etc/ssl/fipsmodule.cnf -module /usr/lib/$(arch)-linux-gnu/ossl-modules/fips.so
# Write the FIPS specify configuration file into the folder.
#cat <<EOF>>/etc/ssl/openssl.cnf
#include fipsmodule.cnf
#
#[provider_sect]
#fips = fips_sect
#base = base_sect
#
#[base_sect]
#activate = 1
#
#[algorithm_sect]
#default_properties = fips=yes
#EOF
#set 

ln -s /etc/ssl/fipsmodule.cnf /usr/lib/ssl/fipsmodule.cnf

sed -i \
    -e '51d' \
    -e '52i ##' \
    -e '52i ## https://www.openssl.org/docs/manmaster/man7/fips_module.html' \
    -e '52i ##' \
    -e '52i .include /etc/ssl/fipsmodule.cnf' \
    -e '54d' \
    -e '55i providers = provider_sect' \
    -e '55i alg_section = algorithm_sect' \
    -e '57d' \
    -e '58d' \
    -e '59i [provider_sect]' \
    -e '59i default = default_sect' \
    -e '59i \\n' \
    -e '61d' \
    -e '62i fips = fips_sect' \
    -e '71d' \
    -e '72d' \
    -e '73i [default_sect]' \
    -e '73i activate = 1' \
    -e '73i [algorithm_sect]' \
    -e '73i default_properties = fips=yes' \
    -e '73i \\n' \
    /etc/ssl/openssl.cnf
