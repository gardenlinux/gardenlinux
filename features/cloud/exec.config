#!/usr/bin/env bash 

chown -R root.root /etc/initramfs-tools
update-initramfs -u

wget https://snapshot.debian.org/archive/debian/20200214T033026Z/pool/main/l/linux-signed-amd64/linux-image-5.4.0-4-cloud-amd64_5.4.19-1_amd64.deb -O /tmp/linux-image-5.4.0-4-cloud-amd64_5.4.19-1_amd64.deb
wget https://snapshot.debian.org/archive/debian/20200214T033026Z/pool/main/l/linux-signed-amd64/linux-image-cloud-amd64_5.4.19-1_amd64.deb -O /tmp/linux-image-cloud-amd64_5.4.19-1_amd64.deb
dpkg -i /tmp/linux-image-5.4.0-4-cloud-amd64_5.4.19-1_amd64.deb /tmp/linux-image-cloud-amd64_5.4.19-1_amd64.deb
rm -f /tmp/linux-image-5.4.0-4-cloud-amd64_5.4.19-1_amd64.deb /tmp/linux-image-cloud-amd64_5.4.19-1_amd64.deb
apt-mark hold linux-image-cloud-amd64
apt-get autoremove --purge -y

# set default umask to a more conservative value
sed -i 's/UMASK\t\t022/UMASK\t\t027/' /etc/login.defs
cat <<EOF >>/etc/pam.d/common-session
# Allow umask to be changed
session optional pam_umask.so
EOF
