#!/usr/bin/env bash

set -euo pipefail

input="$(realpath -- "$1")"
output="$(realpath -- "$2")"

dir="$(mktemp -d)"
pushd "$dir" > /dev/null

export PATH="/builder/image.d:$PATH"

chroot_dir="$(mktemp -d)"
mount -t tmpfs tmpfs "$chroot_dir"
tar --extract --xattrs --xattrs-include '*' --directory "$chroot_dir" < "$input"

cp "$chroot_dir/boot/"vmlinuz* vmlinuz
cp "$chroot_dir/boot/"initrd* initrd

read -r _ cmdline < "$chroot_dir/etc/kernel/cmdline"
echo "$cmdline" > cmdline

mksquashfs "$chroot_dir" root.squashfs -noappend -comp xz -mkfs-time "$BUILDER_TIMESTAMP" -all-time "$BUILDER_TIMESTAMP"

sha256sum root.squashfs | head -c 64 > root.squashfs.sha256sum
echo root.squashfs.sha256sum | cpio -H newc -o | xz --check=crc32 >> initrd

umount "$chroot_dir"
rmdir "$chroot_dir"

tar --create --mtime="@$BUILDER_TIMESTAMP" --sort name --numeric-owner --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=atime,delete=ctime vmlinuz initrd cmdline root.squashfs | gzip > "$output"

popd > /dev/null
rm -rf "$dir"
