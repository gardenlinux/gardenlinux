#!/usr/bin/env bash
set -Eeuo pipefail

# GL-TESTCOV-gardener-config-security-mount-no-sbit
# fix file system permissions for higher security
chmod u-s /sbin/mount.nfs /sbin/mount.cifs

# GL-TESTCOV-gardener-service-containerd-disable
# GL-TESTCOV-gardener-service-ssh-disable
# Disable containerd, Gardener will have to enable it
# TODO: for the time being keep these here as it's more obvious, but they should be moved to file.include
mkdir -p /etc/systemd/system-preset
echo "disable containerd.service" >/etc/systemd/system-preset/00-containerd-disable.preset
echo "disable ssh.service" >/etc/systemd/system-preset/00-ssh-disable.preset
systemctl preset containerd.service
systemctl preset ssh.service

# GL-TESTCOV-gardener-config-iptables-legacy
# Several Gardener components (such as Cilium) are not compatible with iptables-nft
# so we need to revert to iptables-legacy
update-alternatives --set iptables "/usr/sbin/iptables-legacy" >/dev/null
update-alternatives --set ip6tables "/usr/sbin/ip6tables-legacy" >/dev/null
update-alternatives --set arptables "/usr/sbin/arptables-legacy" >/dev/null
update-alternatives --set ebtables "/usr/sbin/ebtables-legacy" >/dev/null

# GL-TESTCOV-gardener-config-sysctl-gce-network-security
# remove rp_filter settings from 60-gce-network-security.conf
gce_network_sysctl_file="/etc/sysctl.d/60-gce-network-security.conf"
if [ -e "$gce_network_sysctl_file" ]; then
    sed -i "/^# Turn on Source Address Verification.*/d" "$gce_network_sysctl_file"
    sed -i "/^# prevent some spoofing attacks.*/d" "$gce_network_sysctl_file"
    sed -i "/^net\.ipv4\.conf\.all\.rp_filter.*/d" "$gce_network_sysctl_file"
    sed -i "/^net\.ipv4\.conf\.default\.rp_filter.*/d" "$gce_network_sysctl_file"
fi
