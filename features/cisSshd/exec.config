#!/usr/bin/env bash
set -Eeuo pipefail

# Define sshd conf permission
chmod 600 /etc/ssh/sshd_config

# Append sshd_config
cat << 'EOF' >> /etc/ssh/sshd_config

#### CIS-HARDENING + CUSTOM ####

# Disable root login
PermitRootLogin no

# Use only SSHv2
Protocol 2

# Disable X11 forwarding
X11Forwarding no

# Strict file permissions
StrictModes yes

# Disable host-based auth
IgnoreRhosts yes
HostbasedAuthentication no

# Verbose logging (logs fingerprint)
LogLevel VERBOSE

# Enable PAM
UsePAM yes

# Disable message of the day
PrintMotd no

# Allow locale env
AcceptEnv LANG LC_*

# SFTP subsystem
Subsystem sftp /usr/lib/openssh/sftp-server -f AUTHPRIV -l INFO

# Idle timeout (your config is stronger than CIS)
ClientAliveInterval 300
ClientAliveCountMax 0

# Only allow public-key authentication
AuthenticationMethods publickey
PubkeyAuthentication yes
PasswordAuthentication no
KbdInteractiveAuthentication no
KerberosAuthentication no
ChallengeResponseAuthentication no
GSSAPIAuthentication no
GSSAPIKeyExchange no

# Limit login grace time
LoginGraceTime 60

# SSH access control
AllowUsers *
AllowGroups *
DenyUsers nobody
DenyGroups nobody

# Disable empty passwords
PermitEmptyPasswords no

# Disable user environment
PermitUserEnvironment no

# Host keys (preferred order)
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

# Crypto hardening
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256

# Rekeying limits
RekeyLimit 512M 6h

# Forwarding restrictions
AllowAgentForwarding no
AllowTcpForwarding no
AllowStreamLocalForwarding no
PermitTunnel no
PermitUserRC no
GatewayPorts no

# MaxAuthTries etc.
MaxAuthTries 4
AllowTCPForwarding no
MaxStartups 10:30:60
MaxSessions 10

# Banner
Banner /etc/issue.net

#### END CIS-HARDENING + CUSTOM ####

