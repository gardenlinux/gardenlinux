#!/usr/bin/env bash
set -Eeuo pipefail

# 1. trigger the conf files of cis-hardening
/opt/cis-hardening/bin/hardening.sh --create-config-files-only --allow-unsupported-distribution &>/dev/null

# 2. Disable the checks not needed/taken care alternately
CONFIGS=(
  restrict_fat.cfg
  logs_permissions.cfg
  var_partition.cfg
  var_nodev.cfg
  var_nosuid.cfg
  var_tmp_noexec.cfg
  var_tmp_partition.cfg
  var_tmp_nodev.cfg
  var_tmp_nosuid.cfg
  var_log_noexec.cfg
  var_log_nosuid.cfg
  var_log_nodev.cfg
  var_log_partition.cfg
  var_log_audit_noexec.cfg
  var_log_audit_nosuid.cfg
  var_log_audit_nodev.cfg
  var_log_audit_partition.cfg
  home_partition.cfg
  home_nosuid.cfg
  home_nodev.cfg
  install_tripwire.cfg
  tripwire_cron.cfg
  logfile_sudo.cfg
  bootloader_ownership.cfg
  bootloader_password.cfg
  enable_nx_support.cfg
  install_apparmor.cfg
  enable_apparmor.cfg
  enforce_or_complain_apparmor.cfg
  enforcing_apparmor.cfg
  configure_chrony.cfg
  configure_ntp.cfg
  disable_ipv6.cfg
  audit_bootloader.cfg
  audit_backlog_limit.cfg
  install_syslog-ng.cfg
  enable_syslog-ng.cfg
  configure_syslog-ng.cfg
  syslog_ng_logfiles_perm.cfg
  syslog-ng_remote_host.cfg
  remote_syslog-ng_acl.cfg
  enable_cron.cfg
  disable_ipv6_router_advertisement.cfg
  disable_ip_forwarding.cfg
  disable_source_routed_packets.cfg
  check_distribution.cfg
  run_shm_nodev.cfg
  run_shm_noexec.cfg
)

for cfg in "${CONFIGS[@]}"; do
    sed -i 's|audit|disabled|' "/opt/cis-hardening/etc/conf.d/$cfg"
done

# 2. Add exceptions to the suid and sgid marked daemons
declare -A EXCEPTIONS_MAP=(
  [find_suid_files.cfg]="/usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/lib/polkit-1/polkit-agent-helper-1 /usr/bin/mailq /usr/sbin/nullmailer-queue"
  [find_sgid_files.cfg]="/usr/libexec/systemd-cron/crontab_setgid"
)

for cfg in "${!EXCEPTIONS_MAP[@]}"; do
  sed -i "s|^EXCEPTIONS=\"\(.*\)\"$|EXCEPTIONS=\"\1 ${EXCEPTIONS_MAP[$cfg]}\"|" \
    "/opt/cis-hardening/etc/conf.d/$cfg"
done

# 3. Logrotate permissions
sed -i 's|create|create 0640 root root|' /etc/logrotate.conf

# 4. Append sshd_config
cat << 'EOF' >> /etc/ssh/sshd_config

#### CIS-HARDENING + CUSTOM ####

# Disable root login
PermitRootLogin no

# Use only SSHv2
Protocol 2

# Disable X11 forwarding
X11Forwarding no

# Strict file permissions
StrictModes yes

# Disable host-based auth
IgnoreRhosts yes
HostbasedAuthentication no

# Verbose logging (logs fingerprint)
LogLevel VERBOSE

# Enable PAM
UsePAM yes

# Disable message of the day
PrintMotd no

# Allow locale env
AcceptEnv LANG LC_*

# SFTP subsystem
Subsystem sftp /usr/lib/openssh/sftp-server -f AUTHPRIV -l INFO

# Idle timeout (your config is stronger than CIS)
ClientAliveInterval 300
ClientAliveCountMax 0

# Only allow public-key authentication
AuthenticationMethods publickey
PubkeyAuthentication yes
PasswordAuthentication no
KbdInteractiveAuthentication no
KerberosAuthentication no
ChallengeResponseAuthentication no
GSSAPIAuthentication no
GSSAPIKeyExchange no

# Limit login grace time
LoginGraceTime 60

# SSH access control
AllowUsers *
AllowGroups *
DenyUsers nobody
DenyGroups nobody

# Disable empty passwords
PermitEmptyPasswords no

# Disable user environment
PermitUserEnvironment no

# Host keys (preferred order)
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

# Crypto hardening
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256

# Rekeying limits
RekeyLimit 512M 6h

# Forwarding restrictions
AllowAgentForwarding no
AllowTcpForwarding no
AllowStreamLocalForwarding no
PermitTunnel no
PermitUserRC no
GatewayPorts no

# MaxAuthTries etc.
MaxAuthTries 4
AllowTCPForwarding no
MaxStartups 10:30:60
MaxSessions 10

# Banner
Banner /etc/issue.net

#### END CIS-HARDENING + CUSTOM ####

EOF