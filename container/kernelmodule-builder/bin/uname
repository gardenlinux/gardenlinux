#!/bin/bash

# Wrapper of "uname -r", which returns the targeted gardenlinux kernel version.

OPTIND=1
ORIG_UNAME="/bin/uname-orig"
USE_ORIG=0
KERNEL_ARCH=$(dpkg --print-architecture)
KERNEL_FLAVOUR=${KERNEL_FLAVOUR:-}
KERNEL_BASE=${KERNEL_BASE:-}

if [ $# -eq 0 ]; then
    ${ORIG_UNAME}
fi

while getopts "aimnoprsv" opt; do
    case "$opt" in
        r)
        if [ -z "${KERNEL_FLAVOUR}" ];then
            basename "$(find /lib/modules -mindepth 1 -maxdepth 1 | grep -F -- "${KERNEL_BASE}" | grep -F -- "${KERNEL_ARCH}" | grep -v 'cloud\|rt' | sort -V | tail -n 1)"
	    else
            basename "$(find /lib/modules -mindepth 1 -maxdepth 1 | grep -F -- "${KERNEL_BASE}" | grep -F -- "${KERNEL_ARCH}" | grep -F -- "${KERNEL_FLAVOUR}" | sort -V | tail -n 1)"
	    fi
	    ;;
        *) USE_ORIG=1
        ;;
    esac
done

if [[ "$USE_ORIG" == 1 ]]; then
    ${ORIG_UNAME} "$@"
fi


